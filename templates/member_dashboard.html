<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- NexusTrade AI - Member Dashboard Mockup v3 (JS for Flask) -->
    <title>NexusTrade AI Lab - Member Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark background */
            color: #E5E7EB; /* Light text */
        }
        .lab-section, .mode-section {
            background-color: #1F2937;
            border: 1px solid #374151;
        }
        .cta-button {
            background-color: #3B82F6;
            transition: background-color 0.3s ease;
        }
        .cta-button:hover {
            background-color: #2563EB;
        }
        .secondary-button {
            background-color: transparent;
            border: 1px solid #3B82F6;
            color: #3B82F6;
        }
        .secondary-button:hover {
            background-color: #3B82F6;
            color: #FFFFFF;
        }
        label { color: #9CA3AF; }
        input[type="text"], input[type="password"], input[type="number"], input[type="date"], textarea, select {
            background-color: #374151;
            border: 1px solid #4B5563;
            color: #E5E7EB;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.8);
        }
        input[type="file"] { color: #9CA3AF; }
        input[type="file"]::file-selector-button {
            background-color: #3B82F6; color: white; border: none;
            padding: 0.5rem 0.75rem; border-radius: 0.375rem;
            cursor: pointer; margin-right: 0.75rem;
        }
        input[type="file"]::file-selector-button:hover { background-color: #2563EB; }
        .disclaimer {
            background-color: #374151; color: #D1D5DB; padding: 0.75rem 1rem;
            border-radius: 0.5rem; font-size: 0.875rem;
            border-left: 4px solid #F59E0B;
        }
        .radio-label {
            display: inline-flex; align-items: center; cursor: pointer;
            margin-right: 1rem; color: #D1D5DB;
        }
        .radio-label input[type="radio"] {
            appearance: none; -webkit-appearance: none; width: 1.25em; height: 1.25em;
            border: 2px solid #4B5563; border-radius: 50%; margin-right: 0.5em;
            outline: none; transition: border-color 0.2s;
        }
        .radio-label input[type="radio"]:checked {
            border-color: #3B82F6; background-color: #3B82F6; position: relative;
        }
        .radio-label input[type="radio"]:checked::before {
            content: ''; display: block; width: 0.65em; height: 0.65em;
            background-color: white; border-radius: 50%;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <nav class="bg-gray-900 border-b border-gray-700 sticky top-0 z-50">
         <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <a href="/" class="text-2xl font-bold text-white">NexusTrade <span class="text-blue-500">AI Lab</span></a>
                    <span class="ml-4 text-sm text-gray-400 hidden sm:inline">- Member Dashboard</span>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="#lab" class="bg-gray-700 text-white px-3 py-2 rounded-md text-sm font-medium">Trading Lab</a>
                        <a href="#" class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">My Profile (Conceptual)</a>
                        <a href="#" class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Billing (Conceptual)</a>
                        <a href="/logout" id="logoutLink" class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Logout</a>
                    </div>
                </div>
                <div class="-mr-2 flex md:hidden">
                    <button type="button" id="dashboard-mobile-menu-button" class="bg-gray-800 inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-700 focus:outline-none">
                        <span class="sr-only">Open main menu</span>
                        <svg class="block h-6 w-6" id="icon-menu" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                        <svg class="hidden h-6 w-6" id="icon-close" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
            </div>
        </div>
        <div class="md:hidden hidden" id="dashboard-mobile-menu">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <a href="#lab" class="bg-gray-700 text-white block px-3 py-2 rounded-md text-base font-medium">Trading Lab</a>
                <a href="#" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium">My Profile</a>
                <a href="#" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Billing</a>
                <a href="/logout" id="logoutLinkMobile" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Logout</a>
            </div>
        </div>
    </nav>

    <main class="flex-grow">
        <section id="lab" class="py-12 sm:py-16">
            <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-12">
                    <h1 class="text-3xl lg:text-4xl font-extrabold text-white">Welcome to the AI Trading Lab</h1>
                    <p class="mt-3 text-lg text-gray-400">Configure your AI, run backtests, and simulate paper trading sessions.</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                    <!-- Backtesting Tool Section -->
                    <div class="mode-section p-6 sm:p-8 rounded-xl shadow-2xl">
                        <h3 class="text-2xl font-bold text-white mb-6 text-center border-b border-gray-700 pb-4">Backtesting Mode</h3>
                        <form id="backtestingForm" class="space-y-6">
                            <div>
                                <label for="backtest_openai_api_key" class="block text-sm font-medium mb-1">OpenAI API Key</label>
                                <input type="password" name="backtest_openai_api_key" id="backtest_openai_api_key" placeholder="sk-xxxxxxxxxx" required>
                            </div>
                            <div>
                                <div class="flex items-center justify-between">
                                    <label for="backtest_strategy_prompt" class="block text-sm font-medium mb-1">Custom AI Strategy Prompt</label>
                                    <a href="/prompt-guide" class="secondary-button text-xs px-2 py-1 rounded-md">How to?</a>
                                </div>
                                <textarea name="backtest_strategy_prompt" id="backtest_strategy_prompt" rows="8" placeholder="Define your AI's backtesting logic..." required></textarea>
                            </div>

                            <div class="space-y-2">
                                <label class="block text-sm font-medium mb-1">Historical Data Source:</label>
                                <div>
                                    <label class="radio-label">
                                        <input type="radio" name="dataSource" value="csv" checked> Upload CSV
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="dataSource" value="exchange"> Fetch from Exchange (Conceptual)
                                    </label>
                                </div>
                            </div>

                            <div id="csvDataSourceFields" class="space-y-6">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label for="backtest_csv_data" class="block text-sm font-medium mb-1">Upload Data (1-min OHLCV CSV)</label>
                                        <input type="file" name="backtest_csv_data" id="backtest_csv_data" accept=".csv">
                                    </div>
                                    <div>
                                        <label for="backtest_days_csv" class="block text-sm font-medium mb-1">Days to Backtest from CSV</label>
                                        <input type="number" name="backtest_days_csv" id="backtest_days_csv" value="7" min="1">
                                    </div>
                                </div>
                                <div>
                                    <label for="backtest_randomize_period_csv" class="block text-sm font-medium mb-1">Randomize Period in CSV?</label>
                                    <select name="backtest_randomize_period_csv" id="backtest_randomize_period_csv">
                                        <option value="yes" selected>Yes</option> <option value="no">No (use latest)</option>
                                    </select>
                                </div>
                            </div>

                            <div id="exchangeDataSourceFields" class="space-y-6 hidden">
                                <div>
                                    <label for="backtest_exchange_pair" class="block text-sm font-medium mb-1">Trading Pair</label>
                                    <input type="text" name="backtest_exchange_pair" id="backtest_exchange_pair" value="BTC/USDT">
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div><label for="backtest_start_date" class="block text-sm font-medium mb-1">Start Date</label><input type="date" name="backtest_start_date" id="backtest_start_date"></div>
                                    <div><label for="backtest_end_date" class="block text-sm font-medium mb-1">End Date</label><input type="date" name="backtest_end_date" id="backtest_end_date"></div>
                                </div>
                                <p class="text-xs text-gray-400">Note: Fetching from exchange is conceptual for this mockup.</p>
                            </div>

                            <div class="pt-4">
                                <button type="submit" id="runBacktestButton" class="w-full cta-button text-white px-6 py-3 rounded-lg font-semibold shadow-lg">Run Backtest</button>
                            </div>
                        </form>
                    </div>

                    <div class="mode-section p-6 sm:p-8 rounded-xl shadow-2xl">
                        <h3 class="text-2xl font-bold text-white mb-6 text-center border-b border-gray-700 pb-4">Live Paper Trading Mode</h3>
                        <form id="paperTradingForm" class="space-y-6">
                            <div><label for="live_openai_api_key" class="block text-sm font-medium mb-1">OpenAI API Key</label><input type="password" name="live_openai_api_key" id="live_openai_api_key" placeholder="sk-xxxxxxxxxx"></div>
                            <div>
                                <div class="flex items-center justify-between">
                                    <label for="live_strategy_prompt" class="block text-sm font-medium mb-1">Custom AI Strategy Prompt</label>
                                    <a href="/prompt-guide" class="secondary-button text-xs px-2 py-1 rounded-md">How to?</a>
                                </div>
                                <textarea name="live_strategy_prompt" id="live_strategy_prompt" rows="8" placeholder="Define your AI's live paper trading logic..."></textarea>
                            </div>
                            <div class="border-t border-gray-700 pt-6"><h4 class="text-md font-semibold text-gray-300 mb-2">Paper Trading Exchange Connection</h4><div class="space-y-4"><div><label for="paper_exchange" class="block text-sm font-medium mb-1">Select Paper Exchange</label><select name="paper_exchange" id="paper_exchange"><option value="binance_paper">Binance (Paper Account)</option><option value="bybit_paper">Bybit (Testnet/Paper)</option></select></div><div><label for="paper_api_key_live" class="block text-sm font-medium mb-1">Paper Trading API Key</label><input type="text" name="paper_api_key_live" id="paper_api_key_live" placeholder="Enter paper account API key"></div><div><label for="paper_api_secret_live" class="block text-sm font-medium mb-1">Paper Trading API Secret</label><input type="password" name="paper_api_secret_live" id="paper_api_secret_live" placeholder="Enter paper account API secret"></div><p class="text-xs text-yellow-400 mt-1 disclaimer"><strong class="font-bold">Important:</strong> Use API keys for paper trading accounts only.</p></div></div>
                            <div class="pt-4"><button type="submit" id="startPaperTradingButton" class="w-full cta-button text-white px-6 py-3 rounded-lg font-semibold shadow-lg">Start Live Paper Session</button></div>
                        </form>
                    </div>
                </div>

                <div id="resultsArea" class="mt-12 lab-section p-6 sm:p-8 rounded-xl shadow-2xl hidden">
                    <h3 class="text-2xl font-semibold text-white mb-6 text-center">Session Results</h3>
                    <div id="equityCurvePlaceholder" class="bg-gray-700 min-h-[200px] rounded-md flex items-center justify-center text-gray-400 mb-6">Equity Curve / Performance Chart Will Appear Here</div>
                    <div id="statsPlaceholder" class="text-gray-300 space-y-2"><p><strong>Status:</strong> <span id="statusText">Pending...</span></p><p><strong>Mode:</strong> <span id="modeText">-</span></p><p><strong>Job ID:</strong> <span id="jobIdText">-</span></p><p><strong>Final Equity:</strong> <span id="finalEquityText">-</span></p><p><strong>Net P/L:</strong> <span id="netPLText">-</span></p><p><strong>Total Trades:</strong> <span id="totalTradesText">-</span></p><p><a href="#" id="tradeLogLink" class="text-blue-400 hover:underline" style="display:none;" target="_blank">Download Full Trade Log (CSV)</a></p><p><a href="#" id="equityCurveLink" class="text-blue-400 hover:underline" style="display:none;" target="_blank">View Equity Curve Image</a></p></div>
                </div>
                 <p class="text-xs text-center text-gray-500 mt-8">(Backend interaction is conceptual in this mockup.)</p>
            </div>
        </section>
    </main>

    <footer class="bg-gray-900 border-t border-gray-700 mt-auto">
         <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-gray-400">&copy; 2025 NexusTrade AI Lab. All rights reserved.</p>
            <p class="text-xs text-gray-500 mt-1">For demonstration and educational purposes only. Trading involves risk.</p>
        </div>
    </footer>

    <script>
        // Mobile menu toggle
        const dashboardMobileMenuButton = document.getElementById('dashboard-mobile-menu-button');
        const dashboardMobileMenu = document.getElementById('dashboard-mobile-menu');
        const iconMenu = document.getElementById('icon-menu');
        const iconClose = document.getElementById('icon-close');

        if (dashboardMobileMenuButton && dashboardMobileMenu && iconMenu && iconClose) {
            dashboardMobileMenuButton.addEventListener('click', () => {
                dashboardMobileMenu.classList.toggle('hidden');
                iconMenu.classList.toggle('hidden');
                iconClose.classList.toggle('hidden');
            });
            dashboardMobileMenu.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', () => {
                    if(!dashboardMobileMenu.classList.contains('hidden')) {
                        dashboardMobileMenu.classList.add('hidden');
                        iconMenu.classList.remove('hidden');
                        iconClose.classList.add('hidden');
                    }
                });
            });
        }

        // Data source toggle for Backtesting form
        const dataSourceRadios = document.querySelectorAll('input[name="dataSource"]');
        const csvFields = document.getElementById('csvDataSourceFields');
        const exchangeFields = document.getElementById('exchangeDataSourceFields');

        dataSourceRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'csv') {
                    csvFields.classList.remove('hidden');
                    exchangeFields.classList.add('hidden');
                } else if (this.value === 'exchange') {
                    csvFields.classList.add('hidden');
                    exchangeFields.classList.remove('hidden');
                }
            });
        });

        // JS for Backtesting Form Submission
        const backtestingForm = document.getElementById('backtestingForm');
        const resultsArea = document.getElementById('resultsArea');
        const statusText = document.getElementById('statusText');
        const modeText = document.getElementById('modeText');
        const jobIdText = document.getElementById('jobIdText');
        const equityCurvePlaceholder = document.getElementById('equityCurvePlaceholder');
        const finalEquityText = document.getElementById('finalEquityText');
        const netPLText = document.getElementById('netPLText');
        const totalTradesText = document.getElementById('totalTradesText');
        const tradeLogLink = document.getElementById('tradeLogLink');
        const equityCurveLink = document.getElementById('equityCurveLink');

        if (backtestingForm) {
            backtestingForm.addEventListener('submit', async function(event) {
                event.preventDefault(); // Prevent default HTML form submission
                console.log("Backtesting form submitted via JS."); // For debugging

                statusText.textContent = 'Submitting backtest job...';
                modeText.textContent = 'Backtest';
                jobIdText.textContent = '-';
                equityCurvePlaceholder.innerHTML = '<p>Processing your backtest...</p><div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-blue-500 mx-auto my-4"></div>';
                finalEquityText.textContent = '-'; netPLText.textContent = '-'; totalTradesText.textContent = '-';
                tradeLogLink.style.display = 'none'; equityCurveLink.style.display = 'none';
                resultsArea.classList.remove('hidden');

                const formData = new FormData(backtestingForm);

                // Log FormData contents for debugging
                // for (let [key, value] of formData.entries()) {
                //     console.log("FormData: ", key, value);
                // }
                // Ensure file is correctly appended if not already handled by FormData(form)
                const csvFileInput = document.getElementById('backtest_csv_data');
                if (formData.get('dataSource') === 'csv' && csvFileInput.files.length > 0) {
                    // FormData(form) should already include the file if the input has a name attribute.
                    // If you were manually constructing FormData, you'd do:
                    // formData.append('backtest_csv_data', csvFileInput.files[0]);
                } else if (formData.get('dataSource') === 'csv' && csvFileInput.files.length === 0) {
                    statusText.textContent = 'Error: Please select a CSV file for backtesting.';
                    equityCurvePlaceholder.innerHTML = '<p class="text-red-400">Error: No CSV file selected.</p>';
                    return; // Stop if CSV is selected but no file
                }


                try {
                    const response = await fetch('/run-backtest', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const errorText = await response.text(); // Get raw error text
                        let errorData = { detail: `Server error: ${response.status}. ${errorText}` };
                        try {
                            errorData = JSON.parse(errorText); // Try to parse as JSON
                        } catch (e) { /* Ignore if not JSON */ }
                        console.error("Server error response:", errorData);
                        throw new Error(`HTTP error ${response.status}: ${errorData.error || errorData.detail || response.statusText}`);
                    }

                    const data = await response.json();
                    console.log("Received data from backend:", data); // For debugging

                    statusText.textContent = data.status || 'Processing Complete';
                    jobIdText.textContent = data.job_id || 'N/A';

                    if (data.status === 'completed' && data.results) {
                        equityCurvePlaceholder.innerHTML = `<img src="${data.results.equity_curve_url}?t=${new Date().getTime()}" alt="Equity Curve for Job ${data.job_id}" class="mx-auto rounded-md max-h-full"/>`;
                        finalEquityText.textContent = data.results.final_equity ? `$${Number(data.results.final_equity).toFixed(2)}` : 'N/A';
                        let startBalance = 10000; // Assuming default, ideally get this from config or response
                        let netPL = data.results.net_pl ? Number(data.results.net_pl) : 0;
                        let netPLPercent = (netPL / startBalance) * 100;
                        netPLText.textContent = `${netPL.toFixed(2)} (${netPLPercent.toFixed(2)}%)`;
                        totalTradesText.textContent = data.results.total_trades !== undefined ? data.results.total_trades : 'N/A';

                        tradeLogLink.href = data.results.trade_log_url;
                        tradeLogLink.style.display = 'inline';
                        equityCurveLink.href = data.results.equity_curve_url; // Link to the image itself
                        equityCurveLink.style.display = 'inline';
                    } else if (data.error) {
                        statusText.textContent = `Error: ${data.error}`;
                        equityCurvePlaceholder.innerHTML = `<p class="text-red-400">Error: ${data.error}</p><p>${data.details || ''}</p>`;
                    }
                } catch (error) {
                    console.error('Error submitting backtest:', error);
                    statusText.textContent = 'Failed to run backtest.';
                    equityCurvePlaceholder.innerHTML = `<p class="text-red-400">An error occurred: ${error.message}. Check browser console and Flask server logs for details.</p>`;
                }
            });
        }

        const paperTradingForm = document.getElementById('paperTradingForm');
        if (paperTradingForm) {
            paperTradingForm.addEventListener('submit', (e) => {
                e.preventDefault();
                alert("Live Paper Trading form submission is conceptual in this mockup.");
                // ... (mock display logic similar to backtest if needed) ...
            });
        }
    </script>

</body>
</html>


